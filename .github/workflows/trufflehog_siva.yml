      - name: Comment on PR if secrets detected
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'trufflehog-results.json';

            if (!fs.existsSync(path)) return;

            const lines = fs.readFileSync(path, 'utf8')
              .split('\n')
              .filter(Boolean)
              .map(line => {
                try {
                  const finding = JSON.parse(line);
                  const file = finding?.SourceMetadata?.Data?.Git?.file || 'unknown';
                  const source = finding?.SourceName || 'unknown';
                  const description = finding?.DetectorDescription || 'n/a';
                  const raw = finding?.Raw || '';
                  const rotation = finding?.ExtraData?.rotation_guide || 'N/A';

                  return `- **File**: \`${file}\`\n  **Source**: ${source}\n  **Detector**: ${description}\n  **Secret**: \`${raw}\`\n  **Rotation Guide**: [Link](${rotation})`;
                } catch (err) {
                  return null;
                }
              })
              .filter(Boolean);

            if (lines.length > 0) {
              const commentBody = [
                'ðŸš¨ **TruffleHog found potential secrets in this PR**',
                '',
                ...lines,
                '',
                '> Please rotate and remove the exposed secrets.'
              ].join('\n');

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody.slice(0, 65000) // GitHub API comment limit
              });
            } else {
              console.log('âœ… No verified secrets to report.');
            }
